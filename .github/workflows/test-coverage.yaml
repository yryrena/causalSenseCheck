name: test-coverage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-coverage:
    runs-on: ubuntu-latest

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup pandoc
        uses: r-lib/actions/setup-pandoc@v2

      # install package deps (Imports + Suggests) and covr
      - name: Install dependencies (incl. covr)
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::covr
            any::testthat
          needs: coverage

      # sanity print: shows which heavy Suggests actually installed
      - name: Session info (debug)
        run: |
          Rscript -e 'print(sessionInfo());
                      pkgs <- c("grf","AER","fixest","ggplot2","rmarkdown");
                      print(pkgs);
                      print(sapply(pkgs, requireNamespace, quietly=TRUE))'

      # run tests and upload coverage DIRECTLY with covr::codecov
      - name: Run tests & upload to Codecov
        run: |
          Rscript -e '
            cov <- covr::package_coverage(type = "tests")
            print(cov)

            # push to Codecov (classic path)
            covr::codecov(
              coverage = cov,
              token = Sys.getenv("CODECOV_TOKEN"),
              quiet = FALSE,
              slug = "yryrena/causalSenseCheck"
            )
          '

      # optional artifact for debugging if something breaks
      - name: Save coverage object as artifact
        if: always()
        run: |
          Rscript -e 'cov <- covr::package_coverage(type = "tests"); saveRDS(cov, file = "coverage_covr_object.rds")'
        shell: bash
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-covr-object
          path: coverage_covr_object.rds
